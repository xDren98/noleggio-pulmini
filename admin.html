<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Imbriani Noleggio</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }
    
    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .stat-icon {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
    }
    
    .stat-icon.blue { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
    .stat-icon.green { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
    .stat-icon.orange { background: rgba(249, 115, 22, 0.1); color: #f97316; }
    .stat-icon.purple { background: rgba(168, 85, 247, 0.1); color: #a855f7; }
    
    .stat-content h3 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .stat-content p {
      color: #666;
      font-size: 14px;
    }
    
    .filters {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 24px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .filters input, .filters select, .filters button {
      padding: 10px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .filters button {
      background: #667eea;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .filters button:hover { background: #5568d3; }
    
    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      background: #f9fafb;
    }
    
    th, td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    
    th {
      font-weight: 600;
      color: #374151;
      font-size: 14px;
    }
    
    td {
      color: #6b7280;
      font-size: 14px;
    }
    
    tr:hover {
      background: #f9fafb;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .badge.success { background: #d1fae5; color: #065f46; }
    .badge.warning { background: #fed7aa; color: #92400e; }
    .badge.info { background: #dbeafe; color: #1e40af; }
    
    .actions {
      display: flex;
      gap: 8px;
    }
    
    .btn-icon {
      padding: 8px;
      border: none;
      background: transparent;
      cursor: pointer;
      border-radius: 6px;
      color: #666;
    }
    
    .btn-icon:hover { background: #f3f4f6; }
    
    .calendar-container {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-top: 24px;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .calendar-header h2 {
      font-size: 20px;
    }
    
    .calendar-nav {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .calendar-nav button {
      padding: 8px 16px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    
    .calendar-day {
      aspect-ratio: 1;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      position: relative;
    }
    
    .calendar-day.header {
      border: none;
      font-weight: 600;
      color: #666;
    }
    
    .calendar-day.occupied {
      background: #fee2e2;
      border-color: #fca5a5;
    }
    
    .calendar-day.available {
      background: #d1fae5;
      border-color: #6ee7b7;
    }
    
    .loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .loader.active { display: flex; }
    
    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <h1>üöê Dashboard Amministrativa</h1>
      <p>Gestione prenotazioni Imbriani Noleggio</p>
    </div>
  </div>

  <div class="container">
    <!-- Statistiche -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon blue">üìã</div>
        <div class="stat-content">
          <h3 id="stat-totali">0</h3>
          <p>Prenotazioni Totali</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green">‚úÖ</div>
        <div class="stat-content">
          <h3 id="stat-completate">0</h3>
          <p>Completate</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon orange">‚è≥</div>
        <div class="stat-content">
          <h3 id="stat-corso">0</h3>
          <p>In Corso</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon purple">üìÖ</div>
        <div class="stat-content">
          <h3 id="stat-future">0</h3>
          <p>Future</p>
        </div>
      </div>
    </div>

    <!-- Filtri -->
    <div class="filters">
      <input type="date" id="filter-data-inizio" placeholder="Data inizio">
      <input type="date" id="filter-data-fine" placeholder="Data fine">
      <select id="filter-pulmino">
        <option value="">Tutti i pulmini</option>
        <option value="EC787NM">Ducato Lungo</option>
        <option value="DN391FW">Ducato Corto</option>
        <option value="DL291XZ">Peugeot</option>
      </select>
      <select id="filter-stato">
        <option value="">Tutti gli stati</option>
        <option value="Prenotato">Prenotato</option>
        <option value="In corso">In corso</option>
        <option value="Completato">Completato</option>
      </select>
      <button onclick="applicaFiltri()">
        <span class="material-icons">filter_list</span>
        Applica Filtri
      </button>
      <button onclick="esportaCSV()" style="background: #22c55e;">
        <span class="material-icons">download</span>
        Esporta CSV
      </button>
    </div>

    <!-- Tabella Prenotazioni -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Pulmino</th>
            <th>Dal</th>
            <th>Al</th>
            <th>Cellulare</th>
            <th>Stato</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <!-- Popolato dinamicamente -->
        </tbody>
      </table>
    </div>

    <!-- Calendario Disponibilit√† -->
    <div class="calendar-container">
      <div class="calendar-header">
        <h2>üìÖ Calendario Disponibilit√†</h2>
        <div class="calendar-nav">
          <button onclick="cambiaMonth(-1)">‚Üê Precedente</button>
          <span id="current-month">Gennaio 2025</span>
          <button onclick="cambiaMonth(1)">Successivo ‚Üí</button>
        </div>
      </div>
      <div class="calendar-grid" id="calendar"></div>
    </div>
  </div>

  <div class="loader" id="loader">
    <div class="spinner"></div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby1saUwj04dfzPqilrLz1GAfwha47Y-n5r6PG0hs7rGRnPexChTaAKrREQCryw3IOs/exec';
    let prenotazioniGlobali = [];
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    async function fetchConRetry(url, options, retries = 3) {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url, options);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return await response.json();
        } catch (error) {
          console.error(`Tentativo ${i + 1} fallito:`, error);
          if (i === retries - 1) throw error;
          await new Promise(r => setTimeout(r, 1000 * (i + 1)));
        }
      }
    }

    async function caricaPrenotazioni() {
      document.getElementById('loader').classList.add('active');
      try {
        const data = await fetchConRetry(SCRIPT_URL + '?action=getAll');
        prenotazioniGlobali = data.prenotazioni || [];
        aggiornaStatistiche();
        mostraPrenotazioni(prenotazioniGlobali);
        generaCalendario();
      } catch (error) {
        alert('Errore caricamento dati: ' + error.message);
      } finally {
        document.getElementById('loader').classList.remove('active');
      }
    }

    function aggiornaStatistiche() {
      const oggi = new Date();
      document.getElementById('stat-totali').textContent = prenotazioniGlobali.length;
      document.getElementById('stat-completate').textContent = prenotazioniGlobali.filter(p => p.stato === 'Completato').length;
      document.getElementById('stat-corso').textContent = prenotazioniGlobali.filter(p => p.stato === 'In corso').length;
      document.getElementById('stat-future').textContent = prenotazioniGlobali.filter(p => new Date(p.dataInizio) > oggi).length;
    }

    function mostraPrenotazioni(prenotazioni) {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';
      
      prenotazioni.forEach(p => {
        const badgeClass = p.stato === 'Completato' ? 'success' : p.stato === 'In corso' ? 'warning' : 'info';
        tbody.innerHTML += `
          <tr>
            <td><strong>${p.cliente}</strong><br><small>${p.codiceFiscale}</small></td>
            <td>${p.pulmino} <small>(${p.targa})</small></td>
            <td>${p.dataInizio} ${p.oraInizio}</td>
            <td>${p.dataFine} ${p.oraFine}</td>
            <td>${p.cellulare}</td>
            <td><span class="badge ${badgeClass}">${p.stato}</span></td>
            <td class="actions">
              <button class="btn-icon" onclick="modificaPrenotazione('${p.id}')" title="Modifica">
                <span class="material-icons">edit</span>
              </button>
              <button class="btn-icon" onclick="eliminaPrenotazione('${p.id}')" title="Elimina">
                <span class="material-icons">delete</span>
              </button>
            </td>
          </tr>
        `;
      });
    }

    function applicaFiltri() {
      const dataInizio = document.getElementById('filter-data-inizio').value;
      const dataFine = document.getElementById('filter-data-fine').value;
      const pulmino = document.getElementById('filter-pulmino').value;
      const stato = document.getElementById('filter-stato').value;
      
      let filtrate = prenotazioniGlobali;
      
      if (dataInizio) filtrate = filtrate.filter(p => p.dataInizio >= dataInizio);
      if (dataFine) filtrate = filtrate.filter(p => p.dataFine <= dataFine);
      if (pulmino) filtrate = filtrate.filter(p => p.targa === pulmino);
      if (stato) filtrate = filtrate.filter(p => p.stato === stato);
      
      mostraPrenotazioni(filtrate);
    }

    function esportaCSV() {
      const csv = [
        ['Cliente', 'CF', 'Pulmino', 'Targa', 'Dal', 'Ora Inizio', 'Al', 'Ora Fine', 'Cellulare', 'Stato'].join(','),
        ...prenotazioniGlobali.map(p => [
          p.cliente, p.codiceFiscale, p.pulmino, p.targa, p.dataInizio, p.oraInizio, p.dataFine, p.oraFine, p.cellulare, p.stato
        ].join(','))
      ].join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `prenotazioni_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    }

    function generaCalendario() {
      const calendar = document.getElementById('calendar');
      const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
      document.getElementById('current-month').textContent = `${monthNames[currentMonth]} ${currentYear}`;
      
      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      
      calendar.innerHTML = '';
      ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'].forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day header';
        header.textContent = day;
        calendar.appendChild(header);
      });
      
      for (let i = 0; i < (firstDay === 0 ? 6 : firstDay - 1); i++) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day';
        calendar.appendChild(empty);
      }
      
      for (let day = 1; day <= daysInMonth; day++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day available';
        dayDiv.textContent = day;
        
        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const occupied = prenotazioniGlobali.some(p => dateStr >= p.dataInizio && dateStr <= p.dataFine);
        if (occupied) dayDiv.className = 'calendar-day occupied';
        
        calendar.appendChild(dayDiv);
      }
    }

    function cambiaMonth(offset) {
      currentMonth += offset;
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      generaCalendario();
    }

    async function modificaPrenotazione(id) {
      alert('[translate:Feature] in sviluppo - Modifica prenotazione ' + id);
    }

    async function eliminaPrenotazione(id) {
      if (!confirm('Sei sicuro di voler eliminare questa prenotazione?')) return;
      try {
        await fetchConRetry(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'delete', id })
        });
        alert('Prenotazione eliminata!');
        caricaPrenotazioni();
      } catch (error) {
        alert('Errore: ' + error.message);
      }
    }

    window.onload = caricaPrenotazioni;
  </script>
</body>
</html>
