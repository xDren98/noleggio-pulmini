<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Imbriani Noleggio</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
body {
  font-family: 'Poppins', sans-serif;
  background: #f7f7f7;
  margin: 0;
  min-height: 100vh;
  padding: 0;
}
#mainbox {
  max-width: 670px;
  margin: 32px auto 54px;
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 2px 10px rgba(44, 93, 42, 0.07);
  padding: 26px 20px 28px;
  display: flex;
  flex-direction: column;
  gap: 21px;
}
header {
  max-width: 670px;
  margin: 0 auto 10px;
  padding-top: 10px;
  text-align: center;
}
header h1 {
  font-weight: 700;
  font-size: 2em;
  color: #37b24d;
  margin: 0 0 4px 0;
}
header p {
  font-weight: 600;
  font-size: 1em;
  color: #516551;
  margin: 0 0 10px 0;
}
#userBar {
  margin: 18px auto 0 auto;
  text-align: center;
}
#loginContainer, #prenotazioniList {
  max-width: 650px;
  margin: 18px auto 0 auto;
}
#loginContainer {
  border: 1px solid #37b24d;
  border-radius: 10px;
  background: #eafbe9;
  padding: 16px;
  display: none;
}
#loginResult {
  margin-top: 14px;
  font-weight: 600;
  color: #2c5d2a;
}
#logoutBtn {
  margin-top: 10px;
}
#prenotazioniList ul {
  padding-left: 20px;
  margin-top: 10px;
}
#prenotazioniList li {
  margin-bottom: 8px;
  padding: 8px;
  background: #fff;
  border-radius: 10px;
  box-shadow: 1px 1px 5px #b9d5b8;
}
.stato-completato {
  color: green;
  font-weight: 700;
}
.stato-in-corso {
  color: red;
  font-weight: 700;
}
.stato-prenotato {
  color: goldenrod;
  font-weight: 700;
}
label {
  font-weight: 600;
  font-size: 1.02em;
  color: #2c5d2a;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.material-icons {
  font-size: 20px;
  color: #37b24d;
}
input[type=text] {
  width: 100%;
  min-height: 43px;
  padding: 7px 10px;
  font-size: 1em;
  border-radius: 10px;
  border: 1.4px solid #72b972;
  box-sizing: border-box;
  color: #2c5d2a;
  background-color: #f9fff7;
  font-family: 'Poppins', sans-serif;
}
input[type=text]:focus {
  outline: none;
  border-color: #37b24d;
  background-color: #fff;
}
button {
  background-color: #37c559;
  color: #fff;
  font-weight: 700;
  border: none;
  border-radius: 14px;
  cursor: pointer;
  font-size: 1.05em;
  padding: 11px 25px;
  user-select: none;
  display: flex;
  align-items: center;
  gap: 7px;
  box-shadow: 0 2px 6px #86e8a2aa;
  transition: background 0.2s, box-shadow 0.2s, transform 0.18s;
  margin-left: 10px;
}
button span.material-icons {
  filter: drop-shadow(0 0 1px #26893a);
}
button:hover:not(:disabled) {
  background-color: #24943d;
  box-shadow: 0 2px 12px #30af5640;
  transform: scale(1.02);
}
button:disabled {
  background-color: #b7d6b7;
  cursor: default;
  box-shadow: none;
  transform: none;
  color: #5c995c;
}
#errorMsg {
  color: red;
  font-weight: 700;
  margin-top: 10px;
  text-align: center;
}
@media (max-width: 640px) {
  #mainbox, header { max-width: 100vw; padding-left: 2vw; padding-right: 2vw; }
}
</style>
</head>
<body>
<header>
  <h1>Imbriani Noleggio</h1>
  <p class="slogan">Dividi i costi, moltiplica il divertimento!</p>
  <div id="userBar">
    <button id="loginBtn">Login Cliente</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
  </div>
</header>
<div id="loginContainer">
  <form id="loginForm">
    <label for="cfInput">Codice Fiscale:</label>
    <input type="text" id="cfInput" maxlength="16" required />
    <div id="errorMsg"></div>
    <button type="submit">Accedi</button>
    <button type="button" id="closeLogin">Chiudi</button>
  </form>
  <div id="loginResult"></div>
</div>
<div id="prenotazioniList"></div>
<div id="mainbox">
  <!-- Altri contenuti della pagina se necessario -->
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginContainer = document.getElementById('loginContainer');
    const loginForm = document.getElementById('loginForm');
    const cfInput = document.getElementById('cfInput');
    const errorMsg = document.getElementById('errorMsg');
    const loginResult = document.getElementById('loginResult');
    const prenotazioniList = document.getElementById('prenotazioniList');
    const closeLoginBtn = document.getElementById('closeLogin');

    const backendUrl = 'https://script.google.com/macros/s/AKfycbyRfwXBfNULgwohG24SDVpHl_68pIPHqTtBxrLkUNwTk53I85YWmkQMG4hjLzOcgnU2/exec';

    loginBtn.addEventListener('click', () => {
      loginContainer.style.display = 'block';
      loginResult.textContent = '';
      errorMsg.textContent = '';
      cfInput.value = '';
    });

    closeLoginBtn.addEventListener('click', () => {
      loginContainer.style.display = 'none';
      loginResult.textContent = '';
      errorMsg.textContent = '';
    });

    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('loginCF');
      prenotazioniList.innerHTML = '';
      loginBtn.style.display = 'inline-block';
      logoutBtn.style.display = 'none';
      loginContainer.style.display = 'none';
    });

    loginForm.addEventListener('submit', e => {
      e.preventDefault();
      errorMsg.textContent = '';
      loginResult.textContent = '';
      let cf = cfInput.value.trim().toUpperCase();

      if (cf.length !== 16) {
        errorMsg.textContent = 'Inserisci un codice fiscale valido di 16 caratteri.';
        return;
      }
      loginBtn.disabled = true;

      fetch(backendUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cf })
      })
      .then(response => response.json())
      .then(data => {
        loginBtn.disabled = false;
        if (!Array.isArray(data)) {
          loginResult.textContent = 'Risposta non valida dal server.';
          return;
        }
        if (data.length === 0) {
          loginResult.textContent = 'Credenziali errate o nessuna prenotazione trovata.';
          return;
        }
        localStorage.setItem('loginCF', cf);
        loginContainer.style.display = 'none';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        mostraPrenotazioni(data);
      }).catch(err => {
        loginBtn.disabled = false;
        loginResult.textContent = 'Errore comunicazione login.';
        console.error(err);
      });
    });

    window.addEventListener('load', () => {
      const savedCf = localStorage.getItem('loginCF');
      if (savedCf) {
        cfInput.value = savedCf;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        loginContainer.style.display = 'none';
        fetch(backendUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cf: savedCf })
        })
        .then(res => res.json())
        .then(data => {
          if (Array.isArray(data) && data.length > 0) {
            mostraPrenotazioni(data);
          }
        });
      }
    });

    function mostraPrenotazioni(data) {
      let html = '<h3>Le tue prenotazioni:</h3><ul>';
      data.forEach(pren => {
        let classeStato = '';
        switch(pren.stato) {
          case 'Completato': classeStato = 'stato-completato'; break;
          case 'In corso': classeStato = 'stato-in-corso'; break;
          case 'Prenotato': classeStato = 'stato-prenotato'; break;
          default: classeStato = '';
        }
        html += `<li>Dal <strong>${pren.dal}</strong> al <strong>${pren.al}</strong> - Pulmino: <strong>${pren.targa}</strong> - Stato: <span class="${classeStato}">${pren.stato}</span></li>`;
      });
      html += '</ul>';
      prenotazioniList.innerHTML = html;
    }
  });
</script>
</body>
</html>
