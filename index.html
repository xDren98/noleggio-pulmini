<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Imbriani Noleggio</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/it.js"></script>
<style>
/* ...[tutti gli stili generali header, form, main, icone qui: vedi versione 4.0 precedente, rimangono invariati]... */

/* Flatpickr stile Imbriani */
.flatpickr-calendar {
  background: #14233a !important;
  border: 2px solid #ffe176 !important;
  border-radius: 14px !important;
  color: #ffe176 !important;
  font-family: 'Poppins', sans-serif !important;
  box-shadow: 0 0 28px #ffe17699 !important;
  padding: 12px !important;
}
.flatpickr-months {
  background: transparent !important;
  border-bottom: 2px solid #ffe176 !important;
  padding: 0 10px !important;
}
.flatpickr-current-month {
  font-weight: 900 !important;
  font-size: 1.25em !important;
  color: #ffe176 !important;
  font-family: 'Poppins', sans-serif !important;
  letter-spacing: 0.06em;
}
.flatpickr-monthDropdown-months,
.flatpickr-current-month input.cur-year {
  background-color: #ffe176 !important;
  color: #193242 !important;
  font-weight: 700 !important;
  border-radius: 8px !important;
  border: none !important;
  outline: none !important;
  font-size: 1em !important;
  font-family: 'Poppins', sans-serif !important;
  padding: 5px 8px !important;
  text-align: center;
  box-shadow: 0 0 12px #d6b7426b !important;
}
.flatpickr-monthDropdown-months {
  margin-right: 8px !important;
  cursor: pointer !important;
}
.flatpickr-current-month input.cur-year {
  width: 56px !important;
  cursor: pointer !important;
}
.flatpickr-weekdays {
  color: #ffe176 !important;
  font-weight: 800 !important;
  font-family: 'Poppins', sans-serif !important;
}
.flatpickr-weekday {
  padding: 4px 0 !important;
  font-weight: 700 !important;
  color: #ffe176 !important;
  text-transform: capitalize !important;
  font-family: 'Poppins', sans-serif !important;
}
.flatpickr-day {
  font-weight: 600 !important;
  color: #ffe176 !important;
  background: transparent !important;
  margin: 2px 3px !important;
  border-radius: 8px !important;
  font-family: 'Poppins', sans-serif !important;
  cursor: pointer !important;
  transition: background-color 0.3s ease !important;
}
.flatpickr-day:hover {
  background: #ffe176 !important;
  color: #193242 !important;
}
.flatpickr-day.today, .flatpickr-day.selected {
  background: #ffe176 !important;
  border-radius: 8px !important;
  color: #193242 !important;
  font-weight: 700 !important;
}
.flatpickr-prev-month, .flatpickr-next-month {
  color: #ffe176 !important;
  width: 32px !important; height: 32px !important;
  border-radius: 50% !important;
  background: transparent !important;
  box-shadow: 0 0 11px #ffe176aa !important;
  cursor: pointer !important;
  font-weight: 900 !important;
  font-size: 1.25em !important;
  font-family: 'Poppins', sans-serif !important;
  line-height: 32px !important;
}
.flatpickr-prev-month:hover, .flatpickr-next-month:hover {
  background: #ffe176 !important;
  color: #193242 !important;
}
</style>
</head>
<body>
<header>
  <h1>Imbriani Noleggio</h1>
  <p class="slogan">Dividi i costi, moltiplica il divertimento!</p>
</header>
<main>
  <!-- RESTO MARKUP COME VERSIONE 4.0 -->
  <!-- Nei form degli autisti: input con id che contiene "data_" sono campi data -->
  <!-- Es: <input type="text" id="data_nascita_1" ... > ecc -->
</main>
<div id="progressContainer">
  <div id="progressBar">
    <div id="progressFill"></div>
    <img id="progressIcon" src="pulmino.png" alt="Pulmino"/>
    <img id="finishFlag" src="traguardo.png" alt="Traguardo"/>
  </div>
  <span id="progressPercent">0%</span>
</div>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/it.js"></script>
<script>
console.log('Imbriani Noleggio - Versione 4.1');

// Flatpickr attivo per tutti i campi data, in italiano, calendario da lunedì, selezione mese e anno dropdown
function aggiornaFlatpickr() {
  flatpickr("input[type='text'][id*='data_']", {
    dateFormat: "d/m/Y",
    locale: "it",
    monthSelectorType: "dropdown",
    firstDayOfWeek: 1,
    disableMobile: true
  });
}
aggiornaFlatpickr();

const pulmini = [
  { id: "ducato_lungo", nome: "Fiat Ducato (Passo lungo)", targa: "EC787NM" },
  { id: "ducato_corto", nome: "Fiat Ducato (Passo corto)", targa: "DN391FW" },
  { id: "peugeot", nome: "Peugeot Expert Tepee", targa: "DL291XZ" }
];
let prenotazioni = [];
const API_KEY = 'AIzaSyCxz6r2f6ZfsPv5tlHNLj5F7_LfWuyww9U';
const SPREADSHEET_ID = '1VAUJNVwxX8OLrkQVJP7IEGrqLIrDjJjrhfr7ABVqtns';
const RANGE = "'Risposte del modulo 1'!A:AL";
function loadSheetsApi() { gapi.load('client', initClient);}
function initClient() {
  gapi.client.init({'apiKey': API_KEY,'discoveryDocs': ["https://sheets.googleapis.com/$discovery/rest?version=v4"],})
  .then(function () {
    return gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID, range: RANGE,
    });
  }).then(function (response) {
    prenotazioni = response.result.values || [];
  }, function (error) {
    alert("Errore nel caricamento delle prenotazioni. Riprova più tardi.");
  });
}
window.onload = function () { loadSheetsApi(); }
function showStep(stepId) {
  document.querySelectorAll('.step').forEach(step=> step.classList.remove('active'));
  document.getElementById(stepId).classList.add('active');
  updateProgressBar(stepId);
}
function updateProgressBar(stepId) {
  const progressFill = document.getElementById('progressFill');
  const progressPercent = document.getElementById('progressPercent');
  const progressIcon = document.getElementById('progressIcon');
  const progressBar = document.getElementById('progressBar');
  let percent = 0;
  switch (stepId) {
    case 'step1': percent = 0; break;
    case 'step2': percent = 25; break;
    case 'step3': percent = 50; break;
    case 'step4': percent = 75; break;
    case 'step5': percent = 100; break;
  }
  progressFill.style.width = percent + '%';
  progressPercent.textContent = percent + '%';
  const barWidth = progressBar.clientWidth;
  const iconWidth = progressIcon.clientWidth;
  let leftPos = (percent / 100) * barWidth - iconWidth / 2;
  leftPos = Math.min(Math.max(0, leftPos), barWidth - iconWidth);
  progressIcon.style.left = leftPos + 'px';
}
function goBack() {
  if (document.getElementById('step5').classList.contains('active')) showStep('step4');
  else if (document.getElementById('step4').classList.contains('active')) showStep('step3');
  else if (document.getElementById('step3').classList.contains('active')) showStep('step2');
  else if (document.getElementById('step2').classList.contains('active')) showStep('step1');
}
function goHome() {
  showStep('step1');
  document.getElementById('data_partenza').value = '';
  document.getElementById('data_arrivo').value = '';
  document.getElementById('ora_partenza').value = '08:00';
  document.getElementById('ora_arrivo').value = '08:00';
  document.getElementById('scelta_pulmino').innerHTML = '<option value="">-- Seleziona un pulmino --</option>';
  document.getElementById('num_autisti').value = '1';
  document.getElementById('cellulare').value = '';
  document.getElementById('autisti_container').innerHTML = '';
  updateProgressBar('step1');
}
function composeJSDate(giorno, ora) {
  if (!giorno || !ora) return null;
  if (giorno.includes('/')) {
    const parts = giorno.split('/');
    // formato flatpickr giorno/mese/anno → yyyy-mm-dd
    giorno = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
  }
  return new Date(`${giorno}T${ora}`);
}
function controllaDisponibilita() {
  const dataRitiro = document.getElementById('data_partenza').value;
  const oraRitiro = document.getElementById('ora_partenza').value;
  const dataArrivo = document.getElementById('data_arrivo').value;
  const oraArrivo = document.getElementById('ora_arrivo').value;
  if (!dataRitiro || !oraRitiro || !dataArrivo || !oraArrivo) {
    alert('Inserisci data e ora validi.');
    return;
  }
  const ritiroDate = composeJSDate(dataRitiro, oraRitiro);
  const arrivoDate = composeJSDate(dataArrivo, oraArrivo);
  if (ritiroDate >= arrivoDate) {
    alert('L\'ora di arrivo deve essere successiva a quella di ritiro.');
    return;
  }
  const rows = prenotazioni.filter(row => row[1] !== 'Nome');
  const disponibili = pulmini.filter(pulmino => {
    return !rows.some(row => {
      if (row[11] !== pulmino.targa) return false;
      const startPrenDate = composeJSDate(row[14], row[12]);
      const endPrenDate = composeJSDate(row[15], row[13]);
      if (!startPrenDate || !endPrenDate) return false;
      // Fascia prenotata INCLUSIVA
      return (startPrenDate < arrivoDate && endPrenDate > ritiroDate);
    });
  });
  const select = document.getElementById('scelta_pulmino');
  select.innerHTML = '<option value="">-- Seleziona un pulmino --</option>' +
    disponibili.map(p => `<option value="${p.id}">${p.nome}</option>`).join("");
  document.getElementById('num_disponibili').textContent = disponibili.length;
  if (disponibili.length === 0) {
    alert('Nessun pulmino disponibile per la fascia selezionata!');
    return;
  }
  showStep('step2');
  document.getElementById('chiamaContinuaBtn').disabled = true;
}
document.getElementById('scelta_pulmino').addEventListener('change', function () {
  document.getElementById('chiamaContinuaBtn').disabled = !this.value;
});
function chiamaEContinua() {
  const pulminoSelezionato = document.getElementById('scelta_pulmino').value;
  if (!pulminoSelezionato) {
    alert('Seleziona un pulmino prima di chiamare.');
    return;
  }
  window.location.href = "tel:3286589618";
  setTimeout(() => { vaiStep3(); }, 500);
}
function vaiStep3() {
  const pulmino = document.getElementById('scelta_pulmino').value;
  if (!pulmino) { alert('Seleziona un pulmino.'); return; }
  showStep('step3');
  mostraModuliAutisti();
}
function vaiStep4() {
  showStep('step4');
  const btnContinua = document.getElementById('btnApriModulo');
  btnContinua.disabled = true;
  let countdown = 10;
  btnContinua.textContent = `Controlla e invia i tuoi dati (${countdown})`;
  const timer = setInterval(() => {
    countdown--;
    btnContinua.textContent = `Controlla e invia i tuoi dati (${countdown})`;
    if (countdown === 0) {
      clearInterval(timer);
      btnContinua.disabled = false;
      btnContinua.textContent = "Controlla e invia i tuoi dati";
    }
  }, 1000);
}
window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('btnApriModulo').addEventListener('click', () => {
    apriModuloPrecompilato();
    setTimeout(() => { showStep('step5'); }, 500);
  });
});
function mostraModuliAutisti() {
  const container = document.getElementById('autisti_container');
  const num = parseInt(document.getElementById('num_autisti').value);
  container.innerHTML = '';
  for (let i = 1; i <= num; i++) {
    container.innerHTML += `<div class="autista">
      <h3>Autista ${i}</h3>
      <label>Nome</label><input type="text" id="nome_${i}" required/>
      <label>Cognome</label><input type="text" id="cognome_${i}" required/>
      <label>Data di nascita</label><input type="text" id="data_nascita_${i}" required/>
      <label>Luogo di nascita</label><input type="text" id="luogo_nascita_${i}" required/>
      <label>Comune di residenza</label><input type="text" id="comune_residenza_${i}" required/>
      <label>Via di residenza</label><input type="text" id="via_residenza_${i}" required/>
      <label>Civico di residenza</label><input type="text" id="civico_residenza_${i}" required/>
      <label>Codice fiscale</label><input type="text" id="codice_fiscale_${i}" required/>
      <label>Numero patente</label><input type="text" id="numero_patente_${i}" required/>
      <label>Data inizio validità patente</label><input type="text" id="inizio_validita_patente_${i}" required/>
      <label>Data fine validità patente</label><input type="text" id="fine_validita_patente_${i}" required/>
    </div>`;
  }
  aggiornaFlatpickr();
}
function apriModuloPrecompilato() {
  const num = parseInt(document.getElementById('num_autisti').value);
  const dataRitiro = document.getElementById('data_partenza').value;
  const oraRitiro = document.getElementById('ora_partenza').value;
  const dataArrivo = document.getElementById('data_arrivo').value;
  const oraArrivo = document.getElementById('ora_arrivo').value;
  const pulminoId = document.getElementById('scelta_pulmino').value;
  const pulminoObj = pulmini.find(p => p.id === pulminoId);
  const targa = pulminoObj ? pulminoObj.targa : "";
  const data_contratto = new Date().toISOString().split('T')[0];
  const cellulare = encodeURIComponent(document.getElementById('cellulare').value);
  const entry = [
    {nome:'550823113',data_nascita:'766463607',luogo_nascita:'1735522613',cf:'36844075',comune_residenza:'913323396',via_residenza:'1329485765',civico_residenza:'1349864501',numero_patente:'1885490374',inizio_patente:'525872521',fine_patente:'1864189410'},
    {nome:'1236551634',data_nascita:'503259772',luogo_nascita:'1977818551',cf:'1883324084',comune_residenza:'2118103863',via_residenza:'805763990',civico_residenza:'568892376',numero_patente:'124831667',inizio_patente:'657885946',fine_patente:'850104184'},
    {nome:'3164128',data_nascita:'1896520037',luogo_nascita:'1923148193',cf:'2061435678',comune_residenza:'767994785',via_residenza:'1335171224',civico_residenza:'1926018707',numero_patente:'1750806014',inizio_patente:'1084842503',fine_patente:'965705170'}
  ];
  let urlModulo = "https://docs.google.com/forms/d/e/1FAIpQLSeakbNHdqxJcfTG90xbTnLnEsmwNWh6q2RZIjtDChiJdhbNhw/viewform?usp=pp_url" +
    `&entry.257199041=${encodeURIComponent(oraRitiro)}` +
    `&entry.917923685=${encodeURIComponent(oraArrivo)}` +
    `&entry.1578287722=${encodeURIComponent(targa)}` +
    `&entry.1499256988=${encodeURIComponent(dataRitiro)}` +
    `&entry.517585546=${encodeURIComponent(dataArrivo)}` +
    `&entry.1888774437=${cellulare}` +
    `&entry.925984482=${encodeURIComponent(data_contratto)}`;
  for (let i = 0; i < num; i++) {
    urlModulo += `&entry.${entry[i].nome}=${encodeURIComponent(document.getElementById('nome_'+(i+1)).value)}`+
      `&entry.${entry[i].data_nascita}=${encodeURIComponent(document.getElementById('data_nascita_'+(i+1)).value)}`+
      `&entry.${entry[i].luogo_nascita}=${encodeURIComponent(document.getElementById('luogo_nascita_'+(i+1)).value)}`+
      `&entry.${entry[i].cf}=${encodeURIComponent(document.getElementById('codice_fiscale_'+(i+1)).value)}`+
      `&entry.${entry[i].comune_residenza}=${encodeURIComponent(document.getElementById('comune_residenza_'+(i+1)).value)}`+
      `&entry.${entry[i].via_residenza}=${encodeURIComponent(document.getElementById('via_residenza_'+(i+1)).value)}`+
      `&entry.${entry[i].civico_residenza}=${encodeURIComponent(document.getElementById('civico_residenza_'+(i+1)).value)}`+
      `&entry.${entry[i].numero_patente}=${encodeURIComponent(document.getElementById('numero_patente_'+(i+1)).value)}`+
      `&entry.${entry[i].inizio_patente}=${encodeURIComponent(document.getElementById('inizio_validita_patente_'+(i+1)).value)}`+
      `&entry.${entry[i].fine_patente}=${encodeURIComponent(document.getElementById('fine_validita_patente_'+(i+1)).value)}`;
  }
  window.open(urlModulo, '_blank');
}
</script>
</body>
</html>
